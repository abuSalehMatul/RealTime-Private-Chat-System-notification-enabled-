<template>
  <div id="app">
    <h4>Tree View</h4><button v-on:click.stop="loadNewData">LOAD</button>
    <div>
      <div styles="width:840px; margin: 0 auto;">
        <div stylse="width:49%; display:inline-block; vertical-align: top; height: 222px;">
          <cnc-vue-jstree
              :data="data2"
              data-is-flat
              text-field-name="label"
              order-field-name="order"
              id-field-name="id"
              parent-field-name="parent.id"
              :can-drop="allowChildren"
              :on-new-item-before="treeNewItemBefore"
              :on-new-item-after="treeNewItemAfter"
              :on-delete-item="treeDeleteItem"
              show-checkbox
              select-on-click
              multiple
              allow-batch
              whole-row
              draggable
              @item-drop="itemDrop"
              @item-click="itemClick"
              @item-select="itemSelect"
              @item-change="itemChange"
              ref="tree">
            <template slot="itemTxt" slot-scope="props">
              <div class='treeitem-text' @_dblclick.stop="props.vm.editItem(props.item)">{{ props.vm.parentId }}: {{ props.vm.item.order }} | {{ props.item.label }} / {{ props.vm.draggable }}</div>
            </template>
            <template slot="itemActions" slot-scope="props">
              <div class='treeitem-actions'>
                <button @click.stop="onItemBtnclick(props.item)">Click</button>
                <button @click.stop="props.vm.editItem(props.item)">Edit</button>
                <button @click.stop="props.vm.addSubItem(props.item)">Add Sub</button>
                <button @click.stop="props.vm.addNextItem(props.item)">Add Next</button>
                <button @click.stop="props.vm.deleteItem(props.item)">X</button>
              </div>
            </template>
          </cnc-vue-jstree>
        </div>
        <div style="display:inline-block;">
        </div>
          <textarea style="height:400px; width:100%;">
            {{ getData() }}
          </textarea>
      </div>
    </div>
    <!-- <h2>Async Loading</h2>
    <div>
      <div style="width:840px; margin: 0 auto;">
        <div style="width:49%; display:inline-block; vertical-align: top;">
          <cnc-vue-jstree
              :data="asyncData"
              :async="loadData"
              show-checkbox
              multiple
              allow-batch
              whole-row>
          </cnc-vue-jstree>
        </div>
        <div style="width:50%; display:inline-block; vertical-align: top;">
        <textarea style="height:300px; width:100%;">
          {{ asyncData }}
        </textarea>
        </div>
      </div>
    </div> -->
  </div>
</template>

<script>
  export default {
    name: 'app',
    data () {
      return {
        msg: 'A Tree Plugin For Vue2',
        data1: [],
        data2: [
          {
            'id': '1',
            'parent': null,
            'order': 'A',
            'label': 'Same but with checkboxes',
            'icon': 'tree-icon tree-icon-formtabs'
          },
          {
            'id': '2',
            'parent': {'id': '1'},
            'order': 'B',
            'label': 'initially selected',
            'icon': 'tree-icon tree-icon-forminput',
            'selected': true
          },
          {
            'id': '3',
            'parent': {'id': '1'},
            'order': 'C',
            'label': 'custom icon',
            'icon': 'fa fa-warning'
          },
          {
            'id': '4',
            'parent': {'id': '1'},
            'order': 'D',
            'label': 'initially open',
            // 'icon': 'fa fa-folder',
            'opened': true,
            'type': 'fieldset'
          },
          {
            'id': '5',
            'parent': {'id': '4'},
            'order': 'E',
            'label': 'Another node'
          },
          {
            'id': '6',
            'parent': {'id': '1'},
            'order': 'G',
            'label': 'custom icon',
            'icon': 'fa fa-warning icon-state-warning'
          },
          {
            'id': '7',
            'parent': {'id': '1'},
            'order': 'M',
            'label': 'disabled node',
            'icon': 'fa fa-check icon-state-success',
            'disabled': true
          },
          {
            'id': '8',
            'order': 'AA',
            'label': 'And wholerow selection'
          }
        ],
        data3: [
          {"type":"fieldset","uid":"setModelRequired","label":"Required","parentUid":"","collapsible":true,"collapsed":true,"validate":true,"setClass":"","container":true,"appName":"cncStudio","modelName":"cncModel","viewName":"cncModel-form","id":"Ns4IzCTygz85a972"},
          {"type":"input","label":"Model Name","model":"model","inputName":"model","parentUid":"Ns4IzCTygz85a972","placeholder":"Must be unique value","default":"","required":true,"appName":"cncStudio","modelName":"cncModel","viewName":"cncModel-form","id":"5sgnBy7hV8vN2eHd","paramName":"testFieldf"},
          {"type":"checkbox","label":"Required","model":"required","parentUid":"Ns4IzCTygz85a972","inputName":"disabled","appName":"cncStudio","modelName":"cncModel","viewName":"cncModel-form","id":"LAYao7zXF5zDCeve"},
          {"type":"fieldset","uid":"setTest","label":"Test","parentUid":"","collapsible":true,"collapsed":true,"validate":true,"setClass":"","container":true,"appName":"cncStudio","modelName":"cncModel","viewName":"cncModel-form","id":"Ns4IzCTfsz85acggg"},
          {"type":"fieldset","uid":"setTest","label":"Last","parentUid":"","collapsible":true,"collapsed":true,"validate":true,"setClass":"","container":true,"appName":"cncStudio","modelName":"cncModel","viewName":"cncModel-form","id":"Ns4IzCTfsz85acge445"}
        ],
        data4: [
          {"type":"fieldset","uid":"setModelRequired","label":"Required 333","parentUid":"","collapsible":true,"collapsed":true,"validate":true,"setClass":"","container":true,"appName":"cncStudio","modelName":"cncModel","viewName":"cncModel-form","id":"Ns4IzCTygz85a972"},
          {"type":"input","label":"Model Name","model":"model","inputName":"model","parentUid":"Ns4IzCTygz85a972","placeholder":"Must be unique value","default":"","required":true,"appName":"cncStudio","modelName":"cncModel","viewName":"cncModel-form","id":"5sgnBy7hV8vN2eHd","paramName":"testFieldf"},
          {"type":"checkbox","label":"Required","model":"required","parentUid":"Ns4IzCTygz85a972","inputName":"disabled","appName":"cncStudio","modelName":"cncModel","viewName":"cncModel-form","id":"LAYao7zXF5zDCeve"}
        ],
        data: [
          {
            'title': 'Same but with checkboxes',
            'children': [
              {
                'title': 'initially selected',
                'selected': true
              },
              {
                'title': 'custom icon',
                'icon': 'fa fa-warning icon-state-danger'
              },
              {
                'title': 'initially open',
                'icon': 'fa fa-folder icon-state-default',
                'opened': true,
                'children': [
                  {
                    'title': 'Another node'
                  }
                ]
              },
              {
                'title': 'custom icon',
                'icon': 'fa fa-warning icon-state-warning'
              },
              {
                'title': 'disabled node',
                'icon': 'fa fa-check icon-state-success',
                'disabled': true
              }
            ]
          },
          {
            'title': 'Same but with checkboxes',
            'opened': true,
            'children': [
              {
                'title': 'initially selected',
                'selected': true
              },
              {
                'title': 'custom icon',
                'icon': 'fa fa-warning icon-state-danger'
              },
              {
                'title': 'initially open',
                'icon': 'fa fa-folder icon-state-default',
                'opened': true,
                'children': [
                  {
                    'title': 'Another node'
                  }
                ]
              },
              {
                'title': 'custom icon',
                'icon': 'fa fa-warning icon-state-warning'
              },
              {
                'title': 'disabled node',
                'icon': 'fa fa-check icon-state-success',
                'disabled': true
              }
            ]
          },
          {
            'title': 'And wholerow selection'
          }
        ],
        
        treeSettings: {
          textFieldName: 'id'
        },
        asyncData: [],
        loadData: (oriNode, resolve) => {
          // console.log(oriNode)
          var id = oriNode.data.id ? oriNode.data.id : 0
          setTimeout(() => {
            let data = []
            if (id > 20) {
              data = []
            } else {
              data = [
                {
                  'text': 'New Item 1...' + id
                },
                {
                  'text': 'New Item 2...' + id
                }
              ]
            }
            resolve(data)
          }, 500)
        }
      }
    },
    methods: {
      treeNewItemBefore (preObj) {
        console.log('treeNewItemBefore', preObj)
        preObj.label = 'TEST'
        // preObj.id = preObj.order + '==zz'
        // Add to Data array before saving
        // preObj.addToDataBefore = true
        // preObj.addToDataAfter = true
        return preObj
      },
      treeNewItemAfter (preObj, callback) {
        console.log('treeNewItemAfter', preObj)
        // preObj.id = preObj.order + '==zz'
        // Add to Data array before saving
        // preObj.addToDataBefore = true
        // preObj.addToDataAfter = true
        return callback(preObj)
      },
      treeDeleteItem (preObj, callback) {
        console.log('treeDeleteItem', preObj)
        // preObj.id = preObj.order + '==zz'
        // Add to Data array before saving
        // preObj.addToDataBefore = true
        // preObj.addToDataAfter = true
        return callback(preObj)
      },
      allowChildren (node) {
        return node.type === 'fieldset'
      },
      onItemBtnclick (node) {
        console.log(node.id + ' btn clicked !')
      },
      loadNewData () {
        var treeComp = this.$refs.tree
        treeComp.loadData(this.data4)
        // this.data3 = this.data4
      },
      getData () {
        return _.orderBy(this.data2, 'order', 'asc');
      },
      itemClick (node) {
        // console.log(node.model.id + ' clicked !')
      },
      itemSelect (node) {
        node.selected = !node.selected
        console.log(node.model.id + ' selected !', node.selected)
      },
      itemDrop (source, destination, changeObj) {
        console.log('dropped', source.title, destination.title, changeObj)
      },
      itemChange (source, changeObj) {
        console.log('dropped', source, changeObj)
        if (!source.id || source.id === '') {
          // Add new item
          var newItem = _.merge({}, source.item, changeObj)
          newItem.id = Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5);
          this.data1.push(newItem)
        } else {
          // Update item
          var index = _.indexOf(this.data1, _.find(this.data1, { id: source.id }))
          this.data1.splice(index, 1, _.merge({}, this.data1[index], changeObj))
        }
      }
    }
  }
</script>

<style>
.tree{
  width: 600px;
  border: 1px solid #ccc;
  height: 300px;
}
#app {
  font-family: 'Avenir', Helvetica, Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-align: center;
  color: #2c3e50;
  /* margin-top: 60px; */
}

h1, h2 {
  font-weight: normal;
}

ul {
  list-style-type: none;
  padding: 0;
}

li {
  display: inline-block;
  margin: 0 10px;
}

a {
  color: #42b983;
}

div{
  display: block;
}
</style>
